{% extends "base.html" %}
{% load static %}
{% block 'title'%} Mais Populares {% endblock %}
{% block 'head' %} 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}"> 
{% endblock %}
{% block 'conteudo'%} 

<h1 class="titulos_segundaspaginas">TODAS AS RECEITAS POPULARES</h1>

<div class="container mb-4">

    <form method="get" class="row g-3 justify-content-center align-items-center">

        <!-- Campo de pesquisa -->
        <div class="col-md-5">
            <input type="text"
                   name="q"
                   class="form-control form-control-lg"
                   placeholder="Pesquisar receita ou mestre..."
                   value="{{ termo }}">
        </div>

        <!-- Filtro de categoria -->
        <div class="col-md-3 text-center">

            <div class="btn-group w-100" role="group">
                
                <button type="submit" name="categoria" value="" 
                    class="btn btn-outline-secondary {% if categoria == '' %}active{% endif %}">
                    Todos
                </button>

                <button type="submit" name="categoria" value="Salgado" 
                    class="btn btn-outline-primary {% if categoria == 'Salgado' %}active{% endif %}">
                    Salgado
                </button>

                <button type="submit" name="categoria" value="Doce" 
                    class="btn btn-outline-primary {% if categoria == 'Doce' %}active{% endif %}">
                    Doce
                </button>

            </div>
        </div>

        <!-- Botão de pesquisa -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-lg w-100">Buscar</button>
        </div>
    </form>

</div>

    
<div class="galeria" id="galeria_populares">
    {% for receita in receitas_populares %}

      <div class="card item"
           style="width: 19pc; cursor: pointer;"
           id="receita-{{receita.id}}"
           title="{{receita.nome_prato}} do mestre {{receita.mestre.username}}"
           onclick="exibirReceita('{{receita.id}}', '{{receita.mestre.username}}')">

            <img src="{{receita.imagem.url}}"
                 alt="Imagem da receita {{receita.nome_prato}}"
                 style="max-height: 200px; object-fit: cover;">

            <div class="info">
              <h3>{{receita.nome_prato}}</h3>
              <h6>Mestre {{receita.mestre.username}}</h6>

              <p>
                <span class="badge text-bg-primary">
                  {% if receita.categoria == "S" %}
                    Salgado
                  {% elif receita.categoria == "Salgado" %}
                    Salgado                                        
                  {% else %}
                    Doce
                  {% endif %}
                </span>

                <span class="badge text-bg-info">{{receita.tempo_preparo}}min</span>
              </p>
            </div>
      </div>

    {% empty %}
      <div class="container">
        <div class="alert alert-danger" role="alert">
          <p class="text-center">Desculpe, não tem nenhuma receita para ser exibida.</p>
        </div>
      </div>
    {% endfor %}
</div>
{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Navegação de páginas" class="mt-4">
    <ul class="pagination justify-content-center">

        <!-- Botão ANTERIOR -->
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&q={{ termo }}&categoria={{ categoria }}">
                   « Anterior
                </a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">« Anterior</span></li>
        {% endif %}

        <!-- Números -->
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ num }}&q={{ termo }}&categoria={{ categoria }}">
                       {{ num }}
                    </a>
                </li>
            {% endif %}
        {% endfor %}

        <!-- Botão PRÓXIMO -->
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&q={{ termo }}&categoria={{ categoria }}">
                   Próxima »
                </a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Próxima »</span></li>
        {% endif %}

    </ul>
</nav>
{% endif %}


<!-- Ícones SVG -->
<svg xmlns="http://www.w3.org/2000/svg" class="d-none">
    <!-- (SVGs mantidos exatamente como estavam) -->
    <symbol id="check2" viewBox="0 0 16 16">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5..."></path>
    </symbol>
    <!-- ... demais símbolos ... -->
</svg>

<!-- Modal EXIBIR RECEITA -->
<div class="modal fade" id="modalExibirReceita" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalExibirReceitaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h1 class="modal-title fs-5 text-center" id="modalExibirReceitaLabel"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="conteudo_gerenciar_receita">
                ...
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function () {
    const closeBtn = document.getElementById('closeMenuBtn');
    const navbarCollapseElement = document.getElementById('navbarCollapse');
    const navbarCollapse = new bootstrap.Collapse(navbarCollapseElement, { toggle: false });

    if (closeBtn) {
        closeBtn.addEventListener("click", () => navbarCollapse.hide());
    }
});

async function exibirReceita(idReceita, mestre) {

    const urlBase = "{% url 'pesquisar_receita' 0 %}".replace('0', '');

    try {              
        const response = await fetch(`${urlBase}${idReceita}`);
    
        if (!response.ok) {
          throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
    
        const receita = await response.json();
        document.getElementById("modalExibirReceitaLabel").innerText =
            `DETALHES DA RECEITA ${receita.nome}`;
        
        document.getElementById('conteudo_gerenciar_receita').innerHTML = `
            <form name="formGerenciarReceita" id="formGerenciarReceita${receita.id}">
              <p>${receita.nome}</p>
              <label>Receita</label><br>
              <textarea class="form-control" readonly rows="5">${receita.receita}</textarea>
              <br>

              <p>
                <span class="badge text-bg-primary">POPULAR ${receita.popular === "sim" ? "SIM" : "NÃO"}</span>
                <span class="badge text-bg-warning">${receita.categoria}</span>
                <span class="badge text-bg-info">${receita.tempo_preparo}min</span>
              </p>

              <h5>Receita do Mestre <mark><b>${mestre}</b></mark></h5>
            </form>
        `;
        
    } catch (error) {
        console.error("Erro ao carregar a receita:", error);
    }

    new bootstrap.Modal(document.getElementById('modalExibirReceita')).show();
}

</script>

{% endblock %}
